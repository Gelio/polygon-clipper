!function(t){function e(a){if(r[a])return r[a].exports;var i=r[a]={i:a,l:!1,exports:{}};return t[a].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var r={};e.m=t,e.c=r,e.d=function(t,r,a){e.o(t,r)||Object.defineProperty(t,r,{configurable:!1,enumerable:!0,get:a})},e.n=function(t){var r=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(r,"a",r),r},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=99)}({10:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(t,e,r){this.r=t,this.g=e,this.b=r,this.fillStyle="rgb("+this.r+", "+this.g+", "+this.b+")"}return t.fromHexString=function(e){var r=e.slice(1,3),a=e.slice(3,5),i=e.slice(5,7);return new t(parseInt(r,16),parseInt(a,16),parseInt(i,16))},t.integerToPaddedHex=function(t){var e=t.toString(16);return 1===e.length?" "+e:e},t.prototype.toHexString=function(){var e=t.integerToPaddedHex(this.r),r=t.integerToPaddedHex(this.g);return"#"+(e+t.integerToPaddedHex(this.b)+r)},t}();e.Color=a},100:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=r(2),i=r(7),n=function(){function t(t){this.handlers=(e={},e[a.NewBackgroundTextureEvent.eventType]=this.onNewBackgroundTexture,e[a.NewHeightMapEvent.eventType]=this.onNewHeightMap,e[a.NewLightColorEvent.eventType]=this.onNewLightColor,e[a.NewLightPositionEvent.eventType]=this.onNewLightPosition,e[a.NewLightTypeEvent.eventType]=this.onNewLightType,e[a.NewNormalMapEvent.eventType]=this.onNewNormalMap,e[a.NewHeightMapIntensityEvent.eventType]=this.onNewHeightMapIntensity,e),this.state=t.state,this.vectorMapPreparer=t.vectorMapPreparer;var e}return t.prototype.canInitialize=function(){return 127===this.state.initializationValue&&(this.state.initializationValue=255,!0)},t.prototype.hasInitialized=function(){return 255===this.state.initializationValue},t.prototype.handleEvent=function(t){this.handlers[t.eventType].call(this,t),this.canInitialize()&&this.vectorMapPreparer.performInitialPreparation()},t.prototype.onNewBackgroundTexture=function(t){this.state.appFillData.backgroundTexture=t.payload,this.state.initializationValue|=1,this.hasInitialized()&&(this.vectorMapPreparer.prepareTextureVectors(),this.vectorMapPreparer.prepareTextureVectorsWithLightColor())},t.prototype.onNewHeightMap=function(t){this.state.appFillData.heightMap=t.payload,this.state.initializationValue|=2,this.hasInitialized()&&(this.vectorMapPreparer.prepareBumpVectors(),this.vectorMapPreparer.applyBumpVectors())},t.prototype.onNewLightColor=function(t){var e=t.payload,r=e.x,a=e.y,n=e.z;this.state.appFillData.lightColor=new i.Vector3(r,a,n),this.state.initializationValue|=4,this.hasInitialized()&&this.vectorMapPreparer.prepareTextureVectorsWithLightColor()},t.prototype.onNewLightPosition=function(t){var e=t.payload,r=e.x,a=e.y,n=e.z;this.state.lightPosition=new i.Vector3(r,a,n),this.state.initializationValue|=8,this.canInitialize()&&this.vectorMapPreparer.performInitialPreparation()},t.prototype.onNewLightType=function(t){this.state.lightType=t.payload,this.state.initializationValue|=16},t.prototype.onNewNormalMap=function(t){this.state.appFillData.normalMap=t.payload,this.state.initializationValue|=32,this.hasInitialized()&&(this.vectorMapPreparer.prepareNormalVectors(),this.vectorMapPreparer.prepareBumpVectors(),this.vectorMapPreparer.applyBumpVectors())},t.prototype.onNewHeightMapIntensity=function(t){this.state.appFillData.heightMapIntensity=t.payload,this.state.initializationValue|=64,this.hasInitialized()&&(this.vectorMapPreparer.prepareBumpVectors(),this.vectorMapPreparer.applyBumpVectors())},t}();e.FillWorkerEventHandler=n},101:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=r(9),i=r(7),n=function(){function t(t){this.state=t}return t.prototype.fillStrips=function(t){var e=this;t.forEach(function(t){for(var r=Math.max(Math.floor(t.fromX),0),a=Math.min(Math.floor(t.toX),e.state.canvasWidth-1),i=r;i<=a;i+=1)e.putPixel(i,t.y)})},t.prototype.putPixel=function(t,e){var r=this.state,a=r.textureVectorsWithLightColor,n=r.distortedNormalVectors,o=r.canvasImageData,s=a[t][e],p=n[t][e],u=this.getLightVersor(t,e),l=i.Vector3.dotProduct(u,p),h=Math.max(0,Math.min(1,l)),c=s.multiply(h).floor(),v=4*(t+e*o.width);o.data[v]=c.x,o.data[v+1]=c.y,o.data[v+2]=c.z,o.data[v+3]=255},t.prototype.getLightVersor=function(t,e){return this.state.lightType===a.LightType.Constant?this.state.lightPosition:i.Vector3.subtract(this.state.lightPosition,new i.Vector3(t,e,0)).normalize()},t}();e.FillWorkerFiller=n},102:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=r(7),i=function(){function t(t){this.state=t}return t.prototype.performInitialPreparation=function(){this.prepareTextureVectors(),this.prepareTextureVectorsWithLightColor(),this.prepareNormalVectors(),this.prepareBumpVectors(),this.applyBumpVectors()},t.prototype.prepareTextureVectors=function(){var t=this.state;t.textureVectors=[];for(var e=t.appFillData.backgroundTexture,r=0;r<t.canvasWidth;r+=1){var i=r%e.width;t.textureVectors.push([]);for(var n=0;n<t.canvasWidth;n+=1){var o=n%e.height,s=4*(i+o*e.width),p=e.data[s],u=e.data[s+1],l=e.data[s+2];t.textureVectors[r].push(new a.Vector3(p,u,l))}}},t.prototype.prepareNormalVectors=function(){var t=this.state;t.normalVectors=[];for(var e=t.appFillData.normalMap,r=0;r<t.canvasWidth;r+=1){var i=r%e.width;t.normalVectors.push([]);for(var n=0;n<t.canvasWidth;n+=1){var o=n%e.height,s=4*(i+o*e.width),p=e.data[s],u=e.data[s+1],l=e.data[s+2],h=a.Vector3.fromNormalMap(p,u,l),c=1/h.z;t.normalVectors[r].push(h.multiply(c))}}},t.prototype.prepareBumpVectors=function(){var t=this.state;t.bumpVectors=[];for(var e=t.appFillData.heightMap,r=e.width-1,i=e.height-1,n=0;n<t.canvasWidth;n+=1){var o=n%e.width;t.bumpVectors.push([]);for(var s=0;s<t.canvasWidth;s+=1){var p=s%e.height,u=4*(o+p*e.width),l=0,h=0;l=o<r?e.data[u+4]-e.data[u]:e.data[u-4*o]-e.data[u],l*=t.appFillData.heightMapIntensity,h=p<i?e.data[u+4*e.width]-e.data[u]:e.data[4*o]-e.data[u],h*=t.appFillData.heightMapIntensity;var c=t.normalVectors[n][s],v=new a.Vector3(1,0,-c.x),d=new a.Vector3(0,1,-c.y),f=a.Vector3.add(v.multiply(l),d.multiply(h));t.bumpVectors[n].push(f)}}},t.prototype.applyBumpVectors=function(){var t=this.state;t.distortedNormalVectors=[];for(var e=0;e<t.canvasWidth;e+=1){t.distortedNormalVectors.push([]);for(var r=0;r<t.canvasHeight;r+=1)t.distortedNormalVectors[e].push(a.Vector3.add(t.normalVectors[e][r],t.bumpVectors[e][r]).normalize())}},t.prototype.prepareTextureVectorsWithLightColor=function(){var t=this.state;t.textureVectorsWithLightColor=[];for(var e=0;e<t.canvasWidth;e+=1){t.textureVectorsWithLightColor.push([]);for(var r=0;r<t.canvasHeight;r+=1)t.textureVectorsWithLightColor[e].push(a.Vector3.multiplyComponents(t.textureVectors[e][r],t.appFillData.lightColor).floor())}},t}();e.VectorMapPreparer=i},16:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(e){this.eventType=t.eventType,this.handled=!1,this.payload=e}return Object.defineProperty(t,"eventType",{get:function(){return"NewBackgroundTexture"},enumerable:!0,configurable:!0}),t}();e.NewBackgroundTextureEvent=a},17:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(e){this.eventType=t.eventType,this.handled=!1,this.payload=e}return Object.defineProperty(t,"eventType",{get:function(){return t.name},enumerable:!0,configurable:!0}),t}();e.NewHeightMapEvent=a},18:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(e){this.eventType=t.eventType,this.handled=!1,this.payload=e}return Object.defineProperty(t,"eventType",{get:function(){return t.name},enumerable:!0,configurable:!0}),t}();e.NewHeightMapIntensityEvent=a},19:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(e){this.eventType=t.eventType,this.handled=!1,this.payload=e}return Object.defineProperty(t,"eventType",{get:function(){return t.name},enumerable:!0,configurable:!0}),t}();e.NewLightColorEvent=a},2:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=r(16);e.NewBackgroundTextureEvent=a.NewBackgroundTextureEvent;var i=r(17);e.NewHeightMapEvent=i.NewHeightMapEvent;var n=r(18);e.NewHeightMapIntensityEvent=n.NewHeightMapIntensityEvent;var o=r(19);e.NewLightColorEvent=o.NewLightColorEvent;var s=r(20);e.NewLightPositionEvent=s.NewLightPositionEvent;var p=r(21);e.NewLightPositionRadiusEvent=p.NewLightPositionRadiusEvent;var u=r(22);e.NewLightTypeEvent=u.NewLightTypeEvent;var l=r(23);e.NewNormalMapEvent=l.NewNormalMapEvent},20:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(e){this.eventType=t.eventType,this.handled=!1,this.payload=e}return Object.defineProperty(t,"eventType",{get:function(){return t.name},enumerable:!0,configurable:!0}),t}();e.NewLightPositionEvent=a},21:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(e){this.eventType=t.eventType,this.handled=!1,this.payload=e}return Object.defineProperty(t,"eventType",{get:function(){return t.name},enumerable:!0,configurable:!0}),t}();e.NewLightPositionRadiusEvent=a},22:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(e){this.eventType=t.eventType,this.handled=!1,this.payload=e}return Object.defineProperty(t,"eventType",{get:function(){return t.name},enumerable:!0,configurable:!0}),t}();e.NewLightTypeEvent=a},23:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(e){this.eventType=t.eventType,this.handled=!1,this.payload=e}return Object.defineProperty(t,"eventType",{get:function(){return t.name},enumerable:!0,configurable:!0}),t}();e.NewNormalMapEvent=a},24:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});!function(t){t[t.CanvasInfo=0]="CanvasInfo",t[t.NewFillDataEvent=1]="NewFillDataEvent",t[t.StartFill=2]="StartFill",t[t.FillStrips=3]="FillStrips",t[t.EndFill=4]="EndFill"}(e.FillWorkerMessageType||(e.FillWorkerMessageType={}))},7:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=r(10),i=function(){function t(t,e,r){this.x=t,this.y=e,this.z=r}return t.fromColor=function(e){return new t(e.r/255,e.g/255,e.b/255)},t.add=function(e,r){return new t(e.x+r.x,e.y+r.y,e.z+r.z)},t.subtract=function(e,r){return new t(e.x-r.x,e.y-r.y,e.z-r.z)},t.crossProduct=function(e,r){return new t(e.y*r.z-e.z*r.y,e.z*r.x-e.x*r.z,e.x*r.y-e.y*r.x)},t.dotProduct=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},t.cosineAngle=function(e,r){return t.dotProduct(e,r)/(e.getLength()*r.getLength())},t.fromNormalMap=function(e,r,a){return new t(e/255*2-1,r/255*2-1,a/255)},t.multiplyComponents=function(e,r){return new t(e.x*r.x,e.y*r.y,e.z*r.z)},t.prototype.toColor=function(){var t=Math.floor(255*this.x),e=Math.floor(255*this.y),r=Math.floor(255*this.z);return new a.Color(t,e,r)},t.prototype.normalize=function(){var e=this.getLength();return new t(this.x/e,this.y/e,this.z/e)},t.prototype.multiply=function(e){return new t(this.x*e,this.y*e,this.z*e)},t.prototype.getLength=function(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2)+Math.pow(this.z,2))},t.prototype.clone=function(){return new t(this.x,this.y,this.z)},t.prototype.invert=function(){return new t(-this.x,-this.y,-this.z)},t.prototype.floor=function(){return new t(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z))},t}();e.Vector3=i},9:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});!function(t){t[t.Constant=0]="Constant",t[t.Moving=1]="Moving"}(e.LightType||(e.LightType={}))},99:function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=r(9),i=r(7),n=r(24),o=r(100),s=r(101),p=r(102),u={appFillData:{backgroundTexture:new ImageData(1,1),normalMap:new ImageData(1,1),heightMap:new ImageData(1,1),heightMapIntensity:1,lightColor:new i.Vector3(0,0,0)},canvasHeight:0,canvasWidth:0,canvasImageData:new ImageData(1,1),lightPosition:new i.Vector3(0,0,1),lightType:a.LightType.Constant,initializationValue:0,textureVectors:[],textureVectorsWithLightColor:[],normalVectors:[],bumpVectors:[],distortedNormalVectors:[]},l=new p.VectorMapPreparer(u),h=new o.FillWorkerEventHandler({state:u,vectorMapPreparer:l}),c=new s.FillWorkerFiller(u);onmessage=function(t){var e=t.data.type;switch(e){case n.FillWorkerMessageType.CanvasInfo:u.canvasWidth=t.data.width,u.canvasHeight=t.data.height;break;case n.FillWorkerMessageType.NewFillDataEvent:h.handleEvent(t.data.event);break;case n.FillWorkerMessageType.StartFill:u.canvasImageData=new ImageData(u.canvasWidth,u.canvasHeight);break;case n.FillWorkerMessageType.FillStrips:c.fillStrips(t.data.fillStrips);break;case n.FillWorkerMessageType.EndFill:postMessage(u.canvasImageData,[u.canvasImageData.data.buffer]);break;default:console.error("Unknown worker message type",e)}}}});